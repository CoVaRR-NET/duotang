

```{r, warning=FALSE, message=FALSE}
source("scripts/plot_selection_estimator.R")

startpar <- list(p=c(0.2, 0.05), s=c(0.05, 0.1))
#startpar <- list(p=c(0.5, 0.1, 0.01), s=c(0, 0.05, 0.05))

setAll=getAllStrictoLineages(meta)
#sublineages_BA5 <- getStrictoSubLineages("BA.5*",meta)
sublineages_BQ <- getStrictoSubLineages("BQ*",meta)
sublineages_XBB <- getStrictoSubLineages("XBB*",meta)

#setAll=setAll[!setAll %in% sublineages_BA5]
setAll=setAll[!setAll %in% sublineages_BQ]
setAll=setAll[!setAll %in% sublineages_XBB]

mutants = list(sublineages_BQ, sublineages_XBB)
mutantNames = list("BQ*", "XBB*", "the rest") #"
col <- c(pal["Omicron BQ"], "XBB"="lightblue")

#mutants = list(sublineages_BA5, sublineages_BQ, sublineages_XBB)
#mutantNames = list("BA.5*","BQ*", "XBB*", "the rest") #"
#color for each lineage
#col <- c(pal["Omicron BA.5"], pal["Omicron BQ"], "XBB"="lightblue")

#Set a starting date
#Note that the startdate shouldn't be too much before both alleles become common
#or rare migration events that die off could throw off the estimation procedure 
#(so that the parameter estimates account for the presence of those alleles long in the past).
startdate<-max(meta$sample_collection_date)-days(120) #Using a later date with less sampling noise

sub.plot.selection.estimate <- function(region,maxdate=NA){
  obj=plot.selection.estimate.ggplot(region=region,
                                        startdate=startdate, startpar=startpar,
                                        reference=c(setAll),
                                        mutants=mutants,
                                        names=mutantNames,
                                        maxdate=maxdate, col=col)
  return(obj)
}

selectionEstimateFits <- list()
selectionEstimateFits[["Canada"]] = sub.plot.selection.estimate(region="Canada")
maxdate=selectionEstimateFits[["Canada"]]$date
selectionEstimateFits[["BC"]] <- sub.plot.selection.estimate(region="Alberta",maxdate=maxdate) #temp hax to get this to build
selectionEstimateFits[["BC"]]$plot1 <- NULL
#sub.plot.selection.estimate(region="British Columbia",maxdate=maxdate)
selectionEstimateFits[["AB"]] <- sub.plot.selection.estimate(region="Alberta",maxdate=maxdate)
selectionEstimateFits[["SK"]] <- sub.plot.selection.estimate(region="Alberta",maxdate=maxdate) #temp hax to get this to build
selectionEstimateFits[["SK"]]$plot1 <- NULL

selectionEstimateFits[["MB"]] <- sub.plot.selection.estimate(region="Manitoba",maxdate=maxdate)
selectionEstimateFits[["ON"]] <- sub.plot.selection.estimate(region="Ontario",maxdate=maxdate)
selectionEstimateFits[["QC"]] <- sub.plot.selection.estimate(region="Quebec",maxdate=maxdate)
selectionEstimateFits[["East"]] <- sub.plot.selection.estimate(region="East provinces (NL+NS+NB)",maxdate=maxdate)
#####################################################
# tabs for displaying in notebook
#each PT tab should have curve plot and breakpoint plot side by side
```

```{r, warning=FALSE, message=FALSE, fig.height=8, fig.width5, warning=FALSE, out.width="50%", results='asis'}
dataAvailable.regions <- all.regions %>% filter(shortname %in% c("Canada", "BC", "AB", "SK", "MA", "ON", "QC", "East"))
apply(dataAvailable.regions,1,function(reg){
  cat("###", reg[["shortname"]], "\n")
  n_min=20
  if(reg[["name"]]=="Canada"){n_min=50}
  cat("####",reg[["name"]],"\n","\n")
  if (is.null(selectionEstimateFits[[reg[["shortname"]]]]$plot1))
  {cat("Not enough data available")}
  else {
    print(selectionEstimateFits[[reg[["shortname"]]]]$plot1)
    print(selectionEstimateFits[[reg[["shortname"]]]]$plot2)
  }
  cat("\n\n")})
  
```

## {.unlisted .unnumbered}

### BA.2 sublineages selection {.tabset}

```{r general settings for selection estimator BA.2}
source("scripts/scanlineages.R")
plotsubvariant <- function(region,min,parentalnode){
  nplot=0
  for(p in allparams) {
    if(!any(is.na(p$fit)) && 
       p$region==region && 
       substr(p$mut[[1]], nchar(p$mut[[1]]), nchar(p$mut[[1]]))!="*" &&
       isSubLineage(parentalnode,p$mut[[1]])){
      if((p$fit)$fit[["s1"]]>0 && sum(p$toplot$n2)>min){
          plot.selection(plotparam=p)
          nplot=nplot+1
      }
    }
  }
  if(nplot==0){
    print("Not enough data available")
  }
}


plotba2 <- function(region,min){
  plotsubvariant(region,min,"BA.2*")
}



plotba5 <- function(region,min){
  plotsubvariant(region,min,"BA.5*")
}


plotothers <- function(region,min){
  nplot=0
  for(p in allparams) {
    if(!any(is.na(p$fit)) && 
       p$region==region && 
       substr(p$mut[[1]], nchar(p$mut[[1]]), nchar(p$mut[[1]]))!="*" &&
       !isSubLineage("BA.2*",p$mut[[1]])){
      if((p$fit)$fit[["s1"]]>0 && sum(p$toplot$n2)>min){
          plot.selection(plotparam=p)
          nplot=nplot+1
      }
    }
  }
  if(nplot==0){
    print("Not enough data available")
  }
}


```


Here we show the trends of the various BA.2.* sublineages over time, relative to the frequency of `r reference[[1]]` by itself (shown for sublineages with at least 50 (Canada) or 20 (provinces) cases). Proportions shown here are only among `r reference[[1]]` (stricto) and the lineage illustrated. Note that these plots are not necessarily representative of trends in each province and that mixing of data from different provinces may lead to  shifts in frequency that are not due to selection.


```{r, warning=FALSE, message=FALSE, fig.height=5, fig.width=5, warning=FALSE, out.width="33%", results='asis'}
tmp=apply(all.regions,1,function(reg){
  cat("####", reg[["shortname"]], "\n")
  n_min=20
  if(reg[["name"]]=="Canada"){n_min=50}
  cat("#####",reg[["name"]],"\n","\n")
  plotba2(reg[["name"]],n_min)
  cat("\n\n")})
  
```



### BA.5 sublineages selection {.tabset}

Here we show the trends of the various BA.5# sublineages over time, relative to the frequency of `r reference[[1]]` by itself (shown for sublineages with at least 50 (Canada) or 20 (provinces) cases). Proportions shown here are only among `r reference[[1]]` (stricto) and the lineage illustrated. Note that these plots are not necessarily representative of trends in each province and that mixing of data from different provinces may lead to  shifts in frequency that are not due to selection.



```{r, warning=FALSE, message=FALSE, fig.height=5, fig.width=5, warning=FALSE, out.width="33%", results='asis'}
tmp=apply(all.regions,1,function(reg){
  cat("####", reg[["shortname"]], "\n")
  n_min=20
  if(reg[["name"]]=="Canada"){n_min=50}
  cat("#####",reg[["name"]],"(n>",n_min,")\n","\n")
  plotba5(reg[["name"]],n_min)
  cat("\n\n")})
  
```

<!-- ### Other sublineages selection {.tabset} -->

<!-- Here we show the trends of the various other sublineages over time, relative to the frequency of `r reference[[1]]` by itself (shown for sublineages with at least 50 (Canada) or 20 (provinces) cases). Proportions shown here are only among `r reference[[1]]` (stricto) and the lineage illustrated. Note that these plots are not necessarily representative of trends in each province and that mixing of data from different provinces may lead to  shifts in frequency that are not due to selection. -->



<!-- ```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height=5, fig.show="hold", fig.width=5, warning=FALSE, out.width="33%", results='asis'} -->
<!-- tmp=apply(all.regions,1,function(reg){ -->
<!--   cat("####", reg[["shortname"]], "\n") -->
<!--   n_min=20 -->
<!--   if(reg[["name"]]=="Canada"){n_min=50} -->
<!--   cat("#####",reg[["name"]],"(n>",n_min,")\n","\n") -->
<!--   plotothers(reg[["name"]],n_min) -->
<!--   cat("\n\n")}) -->

<!-- ``` -->
